<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | ReConstruye</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      padding-top: 70px;
      background: #f4f6f8;
    }

    .stat-card {
      transition: transform .2s, box-shadow .2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 18px rgba(0,0,0,.15);
    }

    .section-box {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
      margin-bottom: 2rem;
    }
  </style>
</head>

<body onload="requireAuth(); loadDashboard();">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container">
    <span class="navbar-brand fw-bold">ReConstruye · Dashboard</span>

    <div class="ms-auto">
      <a href="materials.html" class="btn btn-outline-light me-2">Materiales</a>
      <a href="createpost.html" class="btn btn-outline-light me-2">Publicar</a>
      <a href="profile.html" class="btn btn-outline-light me-2">Perfil</a>
      <button onclick="toggleDark()" class="btn btn-secondary me-2">Modo</button>
      <button onclick="logout()" class="btn btn-danger">Salir</button>
    </div>
  </div>
</nav>

<div class="container">

  <!-- Bienvenida -->
  <div class="section-box">
    <h3 class="fw-bold">Dashboard Personal</h3>
    <p class="text-muted mb-0">
      Gestiona tus publicaciones y visualiza el impacto ambiental del proyecto.
    </p>
  </div>

  <!-- Estadísticas del usuario -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card stat-card p-3 text-center">
        <h5> Publicaciones creadas</h5>
        <h2 id="totalPosts">0</h2>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card stat-card p-3 text-center">
        <h5> En revisión</h5>
        <h2 id="pendingPosts">0</h2>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card stat-card p-3 text-center">
        <h5> Aprobadas</h5>
        <h2 id="approvedPosts">0</h2>
      </div>
    </div>
  </div>

  <!-- Métricas globales -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card stat-card p-3 text-center border-success">
        <h6> Materiales reciclados</h6>
        <h2 id="mMaterials">0</h2>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card stat-card p-3 text-center border-primary">
        <h6> Usuarios participantes</h6>
        <h2 id="mUsers">0</h2>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card stat-card p-3 text-center border-info">
        <h6> Impacto ambiental</h6>
        <h2 id="mImpact">0 kg</h2>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card stat-card p-3 text-center border-warning">
        <h6> Valor recuperado</h6>
        <h2 id="mValue">$0</h2>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="section-box">
    <h4 class="fw-bold mb-3">Impacto del proyecto</h4>

    <div class="row">
      <div class="col-md-6 mb-4">
        <canvas id="postsChart"></canvas>
      </div>

      <div class="col-md-6 mb-4">
        <canvas id="impactChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Acciones rápidas -->
  <div class="section-box">
    <h4 class="fw-bold mb-3">Acciones rápidas</h4>

    <div class="row g-3">
      <div class="col-md-4">
        <a href="createpost.html" class="btn btn-primary w-100">
          + Crear publicación
        </a>
      </div>

      <div class="col-md-4">
        <a href="materials.html" class="btn btn-outline-secondary w-100">
          + Ver materiales
        </a>
      </div>

      <div class="col-md-4">
        <a href="profile.html" class="btn btn-outline-secondary w-100">
          + Editar perfil
        </a>
      </div>
    </div>
  </div>

  <!-- Últimas publicaciones -->
  <div class="section-box">
    <h4 class="fw-bold mb-3">Tus últimas publicaciones</h4>
    <div id="recentPosts" class="text-muted">
      No has publicado materiales aún.
    </div>
  </div>

</div>

<!-- Scripts -->
<script src="js/auth.js"></script>
<script src="js/darkmode.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  function loadDashboard() {
    const user = JSON.parse(localStorage.getItem("loggedUser"));
    const posts = JSON.parse(localStorage.getItem("posts")) || [];

    if (!user) return;

    const myPosts = posts.filter(p => p.user === user.email);
    const approvedMy = myPosts.filter(p => p.approved);
    const pendingMy = myPosts.filter(p => !p.approved);

    document.getElementById("totalPosts").innerText = myPosts.length;
    document.getElementById("pendingPosts").innerText = pendingMy.length;
    document.getElementById("approvedPosts").innerText = approvedMy.length;

    const recent = document.getElementById("recentPosts");
    if (myPosts.length > 0) {
      recent.innerHTML = myPosts
        .slice(-3)
        .reverse()
        .map(p => `
          <div class="border-bottom py-2">
            <strong>${p.title}</strong>
            <div class="text-muted">$${p.price} · ${p.type}</div>
          </div>
        `)
        .join("");
    }

    // Métricas globales
    const approvedGlobal = posts.filter(p => p.approved);

    document.getElementById("mMaterials").innerText = approvedGlobal.length;
    document.getElementById("mUsers").innerText =
      new Set(approvedGlobal.map(p => p.user)).size;
    document.getElementById("mImpact").innerText =
      approvedGlobal.length * 25 + " kg";
    document.getElementById("mValue").innerText =
      "$" + approvedGlobal.reduce((sum, p) => sum + Number(p.price || 0), 0);

    renderCharts(posts);
  }

  function renderCharts(posts) {
    const approved = posts.filter(p => p.approved).length;
    const pending = posts.filter(p => !p.approved).length;

    new Chart(document.getElementById("postsChart"), {
      type: "doughnut",
      data: {
        labels: ["Aprobadas", "En revisión"],
        datasets: [{
          data: [approved, pending]
        }]
      }
    });

    new Chart(document.getElementById("impactChart"), {
      type: "bar",
      data: {
        labels: ["Impacto ambiental"],
        datasets: [{
          label: "Kg reciclados",
          data: [approved * 25]
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
</script>

</body>
</html>
